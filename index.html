<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Observa√ß√£o In Loco ‚Äì Emater-RO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#22c55e">
  <meta name="description" content="Sistema de coleta e an√°lise de visitas t√©cnicas em propriedades rurais">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/dashboard.css">
  <link rel="stylesheet" href="styles/form.css">
  <link rel="stylesheet" href="styles/table.css">
</head>
<body>
<div class="app-shell">
  <aside class="sidebar">
    <div class="logo-area">
      <div class="logo-dot"></div>
      <div class="logo-text">
        <span class="logo-title">In Loco</span>
        <span class="logo-sub">Auditoria Emater-RO</span>
      </div>
    </div>
    <nav class="nav">
      <button class="nav-item active" data-view="view-form">
        <span>‚ûï Nova visita</span>
      </button>
      <button class="nav-item" data-view="view-table">
        <span>üìã Entrevistas</span>
      </button>
      <button class="nav-item" data-view="view-dashboard">
        <span>üìä Painel & KPIs</span>
      </button>
    </nav>
    
    <!-- Status de Conex√£o e Sincroniza√ß√£o -->
    <div class="sync-status-container" style="padding: 12px; margin-top: auto;">
      <div id="syncStatus" class="sync-status online">
        <div class="sync-indicator"></div>
        <div class="sync-text">
          <div class="sync-main-text">Online</div>
          <div class="sync-sub-text">Todos os dados sincronizados</div>
        </div>
      </div>
      <button id="btnForceSync" class="btn-sync" style="display: none;">
        <span>üîÑ</span> Sincronizar Agora
      </button>
    </div>
    
    <div class="sidebar-footer">
      <span class="tag">v1.4.0 - PWA</span>
    </div>
  </aside>

  <main class="main">
    <header class="topbar">
      <div>
        <h1 id="topbar-title">Nova visita in loco</h1>
        <p id="topbar-subtitle">Preencha os dados da propriedade e registre as evid√™ncias observadas.</p>
      </div>
      <div class="topbar-actions">
        <button id="btnExportJson" class="btn ghost small">Exportar tudo (.json)</button>
        <button id="btnExportCsv" class="btn ghost small">Exportar tudo (.csv)</button>
      </div>
    </header>

    <!-- VIEW: FORM -->
    <section id="view-form" class="view active">
      <div class="card">
        <div class="form-header">
          <div class="form-stepper">
            <div class="step-dot active" data-step="1">1</div>
            <div class="step-line"></div>
            <div class="step-dot" data-step="2">2</div>
            <div class="step-line"></div>
            <div class="step-dot" data-step="3">3</div>
            <div class="step-line"></div>
            <div class="step-dot" data-step="4">4</div>
            <div class="step-line"></div>
            <div class="step-dot" data-step="5">5</div>
            <div class="step-line"></div>
            <div class="step-dot" data-step="6">6</div>
            <div class="step-line"></div>
            <div class="step-dot" data-step="7">7</div>
          </div>
          <div class="form-progress">
            <div class="form-progress-bar">
              <div class="form-progress-fill" id="formProgressFill"></div>
            </div>
            <span id="formProgressLabel">Etapa 1 de 7</span>
          </div>
        </div>

        <form id="formInLoco">
          <!-- STEP 1 -->
          <div class="form-step active" data-step="1">
            <h2>Identifica√ß√£o da visita</h2>
            <p class="muted">Campos b√°sicos da propriedade visitada e da equipe envolvida.</p>

            <div class="grid-2">
              <div class="form-group">
                <label>Nome do agricultor</label>
                <input name="agricultor" autocomplete="off">
              </div>
              <div class="form-group">
                <label>Munic√≠pio / Localidade</label>
                <input name="municipio" autocomplete="off">
              </div>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label>Nome da propriedade</label>
                <input name="propriedade" autocomplete="off">
              </div>
              <div class="form-group">
                <label>Data da visita</label>
                <input type="date" name="dataVisita">
              </div>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label>Auditor respons√°vel</label>
                <input name="auditor" autocomplete="off">
              </div>
              <div class="form-group">
                <label>T√©cnico acompanhante (se houver)</label>
                <input name="tecnico" autocomplete="off">
              </div>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="form-step" data-step="2">
            <h2>Pr√°ticas produtivas sustent√°veis (C1)</h2>
            <p class="muted">Registre as evid√™ncias observadas em campo quanto √†s pr√°ticas ambientais.</p>
            <div id="c1Container" class="criteria-grid"></div>
          </div>

          <!-- STEP 3 -->
          <div class="form-step" data-step="3">
            <h2>Estrutura para agrega√ß√£o de valor (C3)</h2>
            <p class="muted">Verifique se h√° infraestrutura e apoio voltados ao beneficiamento e √† agrega√ß√£o de valor.</p>
            <div id="c3Container" class="criteria-grid"></div>
          </div>

          <!-- STEP 4 -->
          <div class="form-step" data-step="4">
            <h2>Inser√ß√£o em mercados (C4)</h2>
            <p class="muted">Observe a rela√ß√£o da propriedade com mercados institucionais e privados.</p>
            <div id="c4Container" class="criteria-grid"></div>

            <div class="form-group">
              <label>A comercializa√ß√£o √© realizada de forma aut√¥noma ou por meio de organiza√ß√£o coletiva?</label>
              <textarea name="c4_descr" rows="3"></textarea>
            </div>
          </div>

          <!-- STEP 5 -->
          <div class="form-step" data-step="5">
            <h2>Resultados percebidos (C2)</h2>
            <p class="muted">Registre os efeitos observados ou relatados na propriedade.</p>
            <div id="c2Container" class="criteria-grid"></div>
          </div>

          <!-- STEP 6 -->
          <div class="form-step" data-step="6">
            <h2>Barreiras e limita√ß√µes observadas</h2>
            <p class="muted">Descreva de forma sint√©tica os principais obst√°culos identificados.</p>

            <div class="form-group">
              <label>Impedimentos √† ado√ß√£o de pr√°ticas sustent√°veis</label>
              <textarea name="b1" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>Principais gargalos para comercializa√ß√£o</label>
              <textarea name="b2" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>Infraestrutura de beneficiamento est√° em uso pleno? Se n√£o, por qu√™?</label>
              <textarea name="b3" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label>A assist√™ncia t√©cnica da Emater-RO cobre as demandas percebidas?</label>
              <textarea name="b4" rows="3"></textarea>
            </div>
          </div>

          <!-- STEP 7 -->
          <div class="form-step" data-step="7">
            <h2>S√≠ntese do auditor</h2>
            <p class="muted">Fa√ßa uma leitura integrada das evid√™ncias, contradi√ß√µes, boas pr√°ticas e fragilidades.</p>

            <div class="form-group">
              <label>Texto livre (at√© 15 linhas)</label>
              <textarea name="sintese" rows="8"></textarea>
            </div>

            <div class="form-footer-actions">
              <button type="button" id="btnLimpar" class="btn ghost">Limpar formul√°rio</button>
              <div class="spacer"></div>
              <button type="button" id="btnSalvarRascunho" class="btn ghost">Salvar rascunho</button>
              <button type="submit" class="btn primary">Concluir visita e salvar</button>
            </div>
          </div>

          <div class="form-nav">
            <button type="button" id="btnPrev" class="btn ghost">‚óÄ Anterior</button>
            <button type="button" id="btnNext" class="btn primary">Pr√≥ximo ‚ñ∂</button>
          </div>
        </form>
      </div>
    </section>

    <!-- VIEW: TABLE -->
    <section id="view-table" class="view">
      <div class="card">
        <header class="card-header">
          <div>
            <h2>Entrevistas coletadas</h2>
            <p class="muted">Clique em uma linha para abrir o espelho completo da visita.</p>
          </div>
          <div class="card-actions">
            <input id="tableSearch" class="input-search" placeholder="Buscar por agricultor ou munic√≠pio...">
            <select id="filterMunicipio" class="input-search" style="max-width: 200px;">
              <option value="">Todos os munic√≠pios</option>
            </select>
            <select id="filterPeriodo" class="input-search" style="max-width: 180px;">
              <option value="">Todos os per√≠odos</option>
              <option value="7">√öltimos 7 dias</option>
              <option value="30">√öltimos 30 dias</option>
              <option value="90">√öltimos 90 dias</option>
            </select>
            <button id="btnExportExcel" class="btn primary ghost small">üìä Excel</button>
            <button id="btnExportPDF" class="btn primary ghost small">üìÑ PDF</button>
            <button id="btnClearAll" class="btn danger ghost small">Limpar todas</button>
          </div>
        </header>

        <div class="table-wrapper">
          <table id="tableEntrevistas">
            <thead>
              <tr>
                <th>Agricultor</th>
                <th>Munic√≠pio</th>
                <th>Data</th>
                <th>% Sustentabilidade</th>
                <th>Mercados (C4)</th>
                <th style="width: 140px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <!-- preenchido via JS -->
            </tbody>
          </table>
          <div id="tableEmpty" class="empty-state">
            Nenhuma visita salva ainda. Conclua um formul√°rio para v√™-lo aqui.
          </div>
        </div>
      </div>
    </section>

    <!-- VIEW: DASHBOARD -->
        <!-- VIEW: DASHBOARD -->
    <section id="view-dashboard" class="view">
      <!-- Filtros do Dashboard -->
      <div class="dashboard-filters">
        <select id="dashFilterMunicipio">
          <option value="">Todos os munic√≠pios</option>
        </select>
        <select id="dashFilterPeriodo">
          <option value="">Todos os per√≠odos</option>
          <option value="7">√öltimos 7 dias</option>
          <option value="30">√öltimos 30 dias</option>
          <option value="90">√öltimos 90 dias</option>
        </select>
        <select id="dashFilterTecnico">
          <option value="">Todos os t√©cnicos</option>
        </select>
        <button id="btnApplyDashFilters" class="btn-apply">Aplicar</button>
        <button id="btnClearDashFilters" class="btn-clear">Limpar</button>
      </div>

      <div class="grid-dashboard">
        <!-- KPIs Resumo -->
        <div class="card kpi-card">
          <h2>Resumo geral</h2>
          <div class="kpi-grid">
            <div class="kpi">
              <span class="kpi-label">Visitas registradas</span>
              <span class="kpi-value" id="kpiTotalVisitas">0</span>
            </div>
            <div class="kpi">
              <span class="kpi-label">% itens "Sim" (geral)</span>
              <span class="kpi-value" id="kpiPctSim">0%</span>
            </div>
            <div class="kpi">
              <span class="kpi-label">√çndice m√©dio C1 (sustentabilidade)</span>
              <span class="kpi-value" id="kpiC1">0%</span>
            </div>
            <div class="kpi">
              <span class="kpi-label">Propriedades com inser√ß√£o em mercados</span>
              <span class="kpi-value" id="kpiMercados">0%</span>
            </div>
          </div>
        </div>

        <!-- Distribui√ß√£o Barras Simples -->
        <div class="card chart-card">
          <h2>Distribui√ß√£o geral das respostas</h2>
          <div class="chart-bar" id="chartSimNaoParcial">
            <!-- barras desenhadas via JS -->
          </div>
        </div>

        <!-- Gr√°fico Pizza (Chart.js) -->
        <div class="card chart-card">
          <h2>Distribui√ß√£o visual (Pizza)</h2>
          <div class="chart-pie-container">
            <canvas id="chartPieDistribution"></canvas>
          </div>
        </div>

        <!-- Ranking Munic√≠pios -->
        <div class="card chart-card">
          <h2>üèÜ Top 5 Munic√≠pios</h2>
          <div id="rankingMunicipios">
            <!-- preenchido via JS -->
          </div>
        </div>

        <!-- Comparativo Regional -->
        <div class="card chart-card" style="grid-column: 1 / -1;">
          <h2>Comparativo Regional (C1-C4 por Munic√≠pio)</h2>
          <div id="comparativoRegional">
            <!-- preenchido via JS -->
          </div>
        </div>

        <!-- Comparativo por Crit√©rio (existente) -->
        <div class="card chart-card">
          <h2>Comparativo por crit√©rio</h2>
          <div class="chart-bars-group" id="chartCriteria">
            <!-- barras C1, C2, C3, C4 -->
          </div>
        </div>

        <!-- Gr√°fico de Linha (Tend√™ncia) -->
        <div class="card chart-card">
          <h2>S√©rie temporal (Tend√™ncia)</h2>
          <div class="chart-trend-container">
            <canvas id="chartTrendLine"></canvas>
          </div>
        </div>

        <!-- Mapa Visual -->
        <div class="card chart-card" style="grid-column: 1 / -1;">
          <h2>üìç Mapa de Visita√ß√µes por Munic√≠pio</h2>
          <div id="mapaVisual">
            <!-- preenchido via JS -->
          </div>
        </div>

        <!-- Timeline Simples (existente) -->
        <div class="card chart-card">
          <h2>S√©rie temporal de visitas (Barras)</h2>
          <div class="chart-timeline" id="chartTimeline">
            <!-- linha simples via JS -->
          </div>
        </div>
      </div>
    </section>

    </main>
</div>
  </main>
</div>

<!-- MODAL ESPELHO -->
<div id="modalOverlay" class="modal-overlay hidden">
  <div class="modal">
    <header class="modal-header">
      <div>
        <h2>Espelho da visita</h2>
        <p class="muted" id="modalSub"></p>
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="btnExportVisitaExcel" class="btn primary ghost small">üìä Excel</button>
        <button id="btnExportVisitaPDF" class="btn primary ghost small">üìÑ PDF</button>
        <button id="btnCloseModal" class="btn ghost small">Fechar</button>
      </div>
    </header>
    <div class="modal-body" id="modalBody">
      <!-- conte√∫do via JS -->
    </div>
  </div>
</div>

<!-- Bibliotecas de exporta√ß√£o -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- Offline & PWA -->
<script src="offline-storage.js"></script>
<script src="sync-manager.js"></script>

<!-- App Scripts -->
<script src="db.js"></script>
<script src="charts.js"></script>
<script src="dashboard.js"></script>
<script src="filters-export.js"></script>
<script src="ui.js"></script>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('‚úÖ Service Worker registrado:', registration.scope);
        
        // Listener para Background Sync
        registration.addEventListener('updatefound', () => {
          console.log('üîÑ Nova vers√£o do Service Worker encontrada');
        });
      })
      .catch(err => {
        console.error('‚ùå Erro ao registrar Service Worker:', err);
      });
      
    // Listener para mensagens do Service Worker
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data.type === 'BACKGROUND_SYNC') {
        console.log('üîÑ Background Sync ativado');
        if (window.syncManager) {
          syncManager.syncPending();
        }
      }
    });
  });
}

// UI de Status de Sincroniza√ß√£o
function initSyncUI() {
  const statusEl = document.getElementById('syncStatus');
  const btnSync = document.getElementById('btnForceSync');
  
  if (!statusEl || !btnSync) return;
  
  // Atualizar status inicial
  updateSyncStatus();
  
  // Listener do SyncManager
  syncManager.addListener((event, data) => {
    updateSyncStatus(event, data);
  });
  
  // Bot√£o de sincroniza√ß√£o manual
  btnSync.addEventListener('click', () => {
    syncManager.forcSync();
  });
}

async function updateSyncStatus(event = null, data = null) {
  const statusEl = document.getElementById('syncStatus');
  const btnSync = document.getElementById('btnForceSync');
  
  if (!statusEl) return;
  
  const status = await syncManager.getStatus();
  const { isOnline, isSyncing, pending } = status;
  
  // Remover classes antigas
  statusEl.className = 'sync-status';
  
  if (isSyncing) {
    statusEl.classList.add('syncing');
    statusEl.querySelector('.sync-main-text').textContent = 'Sincronizando...';
    statusEl.querySelector('.sync-sub-text').textContent = `${pending} visita(s) pendente(s)`;
    btnSync.style.display = 'none';
  } else if (!isOnline) {
    statusEl.classList.add('offline');
    statusEl.querySelector('.sync-main-text').textContent = 'Offline';
    statusEl.querySelector('.sync-sub-text').textContent = pending > 0 
      ? `${pending} visita(s) aguardando sincroniza√ß√£o`
      : 'Modo offline ativado';
    btnSync.style.display = pending > 0 ? 'none' : 'none';
  } else if (pending > 0) {
    statusEl.classList.add('pending');
    statusEl.querySelector('.sync-main-text').textContent = 'Pendente';
    statusEl.querySelector('.sync-sub-text').textContent = `${pending} visita(s) para sincronizar`;
    btnSync.style.display = 'block';
  } else {
    statusEl.classList.add('online');
    statusEl.querySelector('.sync-main-text').textContent = 'Online';
    statusEl.querySelector('.sync-sub-text').textContent = 'Todos os dados sincronizados';
    btnSync.style.display = 'none';
  }
  
  // Eventos espec√≠ficos
  if (event === 'sync-complete' && data) {
    if (data.success > 0) {
      showToast(`‚úÖ ${data.success} visita(s) sincronizada(s)`, 'success');
    }
    if (data.failed > 0) {
      showToast(`‚ö†Ô∏è ${data.failed} visita(s) falharam`, 'warning');
    }
  }
  
  if (event === 'sync-error' && data) {
    showToast(`‚ùå Erro: ${data.error}`, 'error');
  }
}

function showToast(message, type = 'info') {
  // Toast simples (pode ser melhorado depois)
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Inicializar UI de sincroniza√ß√£o ap√≥s carregar
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    initSyncUI();
  }, 1500);
});
</script>

</body>
</html>
